###############################################################################
# â›‘  Build stage â€“ å®‰è£æ‰€æœ‰ä¾è³´ã€ç”¢ç”Ÿ Prisma Client
###############################################################################
FROM node:18-bullseye-slim AS builder

WORKDIR /app

# 1. è¤‡è£½ä¾è³´æ¸…å–®ä¸¦å®‰è£ã€Œå…¨éƒ¨ä¾è³´ã€
COPY package.json pnpm-lock.yaml* ./
RUN corepack enable \
  && corepack prepare pnpm@8.15.4 --activate \
  && pnpm install

# 2. è¤‡è£½æ•´å€‹å°ˆæ¡ˆåŸå§‹ç¢¼
COPY . .

# 3. ç”¢ç”Ÿ Prisma Clientï¼ˆç”¢ç”Ÿåˆ° node_modules/.prisma èˆ‡ @prisma/clientï¼‰
RUN npx prisma generate

###############################################################################
# ğŸš€  Runtime stage â€“ åƒ…ç•™ production ä¾è³´ï¼Œæ˜ åƒæª”æœ€å°
###############################################################################
FROM node:18-bullseye-slim

WORKDIR /app

# 1. å…ˆè¤‡è£½ä¾è³´æ¸…å–®ä¸¦å®‰è£ *production* ä¾è³´
COPY package.json pnpm-lock.yaml* ./
RUN corepack enable \
  && corepack prepare pnpm@8.15.4 --activate \
  && pnpm install --prod

# 2. è¤‡è£½ç¨‹å¼ç¢¼èˆ‡ Prisma schemaï¼ˆéœ€åœ¨ generate å‰å°±æ”¾å¥½ï¼‰
COPY --from=builder /app/prisma ./prisma
# 3. å†æ¬¡ç”¢ç”Ÿã€Œç²¾ç°¡ç‰ˆã€ Prisma Clientï¼ˆåƒ… production ä¾è³´ï¼Œé«”ç©æ›´å°ï¼‰
RUN npx --package prisma -c "prisma generate"

# 4. è¤‡è£½å…¶å®ƒéœæ…‹è³‡æºï¼ˆå¦‚æœæœ‰ï¼‰
COPY --from=builder /app/docs ./docs

# 5. è¤‡è£½æ‡‰ç”¨ç¨‹å¼åŸå§‹ç¢¼èˆ‡ï¼ˆå¯é¸ï¼‰seed è…³æœ¬
COPY --from=builder /app/src ./src
COPY --from=builder /app/prisma/seed.js ./prisma/seed.js

# 6. é è¨­ç’°å¢ƒè®Šæ•¸èˆ‡å¥åº·æª¢æŸ¥ï¼ˆå¯è‡ªè¡Œèª¿æ•´ï¼‰
ENV NODE_ENV=production
HEALTHCHECK --interval=30s --timeout=5s --retries=3 CMD node -e \
  "require('http').get('http://localhost:3000/health', res => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"

# 7. å•Ÿå‹•æœå‹™
EXPOSE 3000
CMD ["node", "src/index.js"]
